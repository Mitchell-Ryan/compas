<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Session handling | Compas</title>
    <meta name="description" content="Unified backend tooling">
    <link rel="stylesheet" href="/assets/style.c3210e46.css">
    <link rel="modulepreload" href="/assets/app.cf930e1c.js">
    <link rel="modulepreload" href="/assets/features_session-handling.md.098b3081.lean.js">
    
    <meta name="twitter:title" content="Session handling | Compas">
  <meta property="og:title" content="Session handling | Compas">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Compas, back to home" data-v-675d8756 data-v-cc01ef16><!----> Compas</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/getting-started.html" data-v-b8818f8c>Docs <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/examples.html" data-v-b8818f8c>Examples <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/changelog" data-v-b8818f8c>Changelog <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/releases/index.html" data-v-b8818f8c>Release notes <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/compasjs/compas" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/getting-started.html" data-v-b8818f8c>Docs <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/examples.html" data-v-b8818f8c>Examples <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/changelog" data-v-b8818f8c>Changelog <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/releases/index.html" data-v-b8818f8c>Release notes <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/compasjs/compas" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/getting-started.html">Getting started</a><!----></li><li class="sidebar-link"><p class="sidebar-link-item">Features</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/features/cli.html">CLI</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/lint-setup.html">Linting and formatting</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/typescript-setup.html">Typescript setup</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/logger-and-events.html">Logger &amp; events</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/config-files.html">Configuration files</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/test-and-bench-runner.html">Testing and benchmarking</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/http-server.html">HTTP server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/postgres-and-minio.html">Postgres and Minio</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/code-gen-validators.html">Code generation</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/code-gen-api.html">Code generation API</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/code-gen-api-client.html">Code generation API client</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/code-gen-sql.html">Code generation SQL queries</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/code-gen-crud.html">Code generation CRUD</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/migrations.html">Postgres migrations</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/background-jobs.html">Background jobs</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/features/session-handling.html">Session handling</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#json-web-token-based">JSON Web Token based</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#session-store">Session store</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#session-transport">Session transport</a><!----></li></ul></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/file-handling.html">File handling</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/extending-the-cli.html">Extending the CLI</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/features/route-invalidations.html">Route invalidations</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/examples.html">Examples</a><!----></li><li class="sidebar-link"><p class="sidebar-link-item">References</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/references/compas-config.html">Compas configuration</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/references/cli.html">CLI Reference</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/migrations/index.html">Migrations</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/migrations/store.html">@compas/store</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="session-handling" tabindex="-1">Session handling <a class="header-anchor" href="#session-handling" aria-hidden="true">#</a></h1><p>Since Compas v0.0.172 Compas provides a session store based on JSON Web Tokens and provides session transport support via authorizatoin headers.</p><h2 id="json-web-token-based" tabindex="-1">JSON Web Token based <a class="header-anchor" href="#json-web-token-based" aria-hidden="true">#</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Requires <code>@compas/store</code> to be installed</p></div><p>Let&#39;s see what Compas brings to the table for sessions. Session in Compas allow you to persist a data object in PostgreSQL so you can for example keep track if a user is logged in, and add the user id to that object so you can use it when necessary. Although JWT&#39;s are often used in combination with claim&#39;s, for example which permissions a user has and what it&#39;s ID is, Compas doesn&#39;t support it this way. The tokens only contain an identifier and expiration time, which then can be used in the backend to find the underlying session object. This way you have all the controls on the backend and can create specific routes to expose things like which permissions the user has.</p><p>The tokens are always created in pairs: an access token and refresh token. The access token is often short-lived, like 10 - 15 minutes stored in memory, and is used to authenticate with api calls. The refresh token on the other hand has a longer time to live, often limited based on the expected attack vectors like if the application is used in public libraries for example, and can be used to fetch a new token pair.</p><p>Let&#39;s take a look at the provided utilities by <code>@compas/store</code>. Most functions will return a <code>Either&lt;X, AppError&gt;</code>, meaning that callers should handle <code>returnValue.error</code> and handle these appropriately.</p><h3 id="session-store" tabindex="-1">Session store <a class="header-anchor" href="#session-store" aria-hidden="true">#</a></h3><p>Let&#39;s look at the primitives first. These are for creating session tokens, storing information with that session and invalidating it.</p><h4 id="sessionstoresettings" tabindex="-1"><code>sessionStoreSettings</code> <a class="header-anchor" href="#sessionstoresettings" aria-hidden="true">#</a></h4><p>Session store settings is an object expected by various functions, containing the following properties:</p><ul><li><code>accessTokenMaxAgeInSeconds</code> (number): How long access tokens should be valid. As mentioned, this should be short like 5 to 15 minutes.</li><li><code>refreshTokenMaxAgeInSeconds</code> (number): How long refresh tokens should be valid</li><li><code>signingKey</code> (string,&gt;20 chars): The key used for signing JWT&#39;s. By changing this value, all sessions will be invalidated. The value should be handled as a secret and should be generated in a secure random way.</li></ul><h4 id="sessionstorecreate" tabindex="-1"><code>sessionStoreCreate</code> <a class="header-anchor" href="#sessionstorecreate" aria-hidden="true">#</a></h4><p>Creates a new session with the provided <code>sessionData</code> and returns a token pair.</p><p><strong>Example</strong>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sessionStoreCreate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">accessTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 5 minutes</span>
  <span class="token literal-property property">refreshTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 24 hours</span>
  <span class="token literal-property property">signingKey</span><span class="token operator">:</span> <span class="token string">&quot;secure key loaded from secure place&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> tokenPair <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sessionStoreCreate</span><span class="token punctuation">(</span>
  <span class="token function">newEventFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
  sql<span class="token punctuation">,</span>
  settings<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&quot;.user.id&quot;</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>otherProps<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle error</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// send token pair to client</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Errors</strong>:</p><ul><li><code>validator.error</code> -&gt; thrown when <code>sessionSettings</code> has validator errors</li><li><code>error.server.internal</code> -&gt; if for some reason the JWT signing library can&#39;t create the access or refresh token.</li></ul><h4 id="sessionstoreget" tabindex="-1"><code>sessionStoreGet</code> <a class="header-anchor" href="#sessionstoreget" aria-hidden="true">#</a></h4><p>Get the session object from the <code>accessTokenString</code>. Note that this returns the full database backed object. The <code>id</code> is necessary for updating the session object and <code>data</code> contains the saved object for this session.</p><p><strong>Example</strong>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sessionStoreGet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">accessTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 5 minutes</span>
  <span class="token literal-property property">refreshTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 24 hours</span>
  <span class="token literal-property property">signingKey</span><span class="token operator">:</span> <span class="token string">&quot;secure key loaded from secure place&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Get Authorization header, showing the Koa way.</span>
<span class="token keyword">const</span> header <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>header<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// throw invalid header</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> accessTokenString <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sessionStoreGet</span><span class="token punctuation">(</span>
  <span class="token function">newEventFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
  sql<span class="token punctuation">,</span>
  settings<span class="token punctuation">,</span>
  accessTokenString<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle error</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
  <span class="token comment">// id is used for updating the session,</span>
  <span class="token comment">// data contains your saved session data</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Errors</strong>:</p><ul><li><code>validator.error</code> -&gt; thrown when <code>sessionSettings</code> has validator errors</li><li><code>error.server.internal</code> -&gt; if for some reason the JWT validating library can&#39;t decode or validate the provided access token.</li><li><code>sessionStore.verifyAndDecodeJWT.invalidToken</code> -&gt; when the token is not issued by this backend, or if it is edited by an unauthorized entity.</li><li><code>sessionStore.verifyAndDecodeJWT.expiredToken</code> -&gt; if the <code>exp</code> of the token before the current time.</li><li><code>sessionStore.get.invalidAcessToken</code> -&gt; when the decoded access token is not conforming the expected structure.</li><li><code>sessionStore.get.invalidSession</code> -&gt; when no session can be found by the provided access token.</li><li><code>sessionStore.get.revokedToken</code> -&gt; when the token is revoked, via for example <code>sessionStoreInvalidate</code> or when a new token pair is issued via <code>sessionStoreRefreshTokens</code>.</li></ul><h4 id="sessionstoreupdate" tabindex="-1"><code>sessionStoreUpdate</code> <a class="header-anchor" href="#sessionstoreupdate" aria-hidden="true">#</a></h4><p>Update the data stored for the provided session. This function will check if the object is changed and only do a database call when that is the case.</p><p><strong>Example</strong>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sessionStoreUpdate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sessionStoreUpdate</span><span class="token punctuation">(</span><span class="token function">newEventFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;my-session-id&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle error</span>
<span class="token punctuation">}</span>
<span class="token comment">// Session is saved or wasn&#39;t changed</span>
</code></pre></div><p><strong>Errors</strong>:</p><p><code>sessionStore.update.invalidSession</code> -&gt; when the provided session has an invalid id or if the data is not a plain JS object.</p><h4 id="sessionstoreinvalidate" tabindex="-1"><code>sessionStoreInvalidate</code> <a class="header-anchor" href="#sessionstoreinvalidate" aria-hidden="true">#</a></h4><p>Revoke all tokens for the provided session.</p><p><strong>Example</strong>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sessionStoreInvalidate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sessionStoreInvalidate</span><span class="token punctuation">(</span><span class="token function">newEventFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;my-session-id&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle error</span>
<span class="token punctuation">}</span>
<span class="token comment">// Session is completely invalidated</span>
</code></pre></div><p><strong>Errors</strong>:</p><ul><li><code>sessionStore.invalidate.invalidSession</code> -&gt; the provided session does not contain a valid identifier.</li></ul><h4 id="sessionstorerefreshtokens" tabindex="-1"><code>sessionStoreRefreshTokens</code> <a class="header-anchor" href="#sessionstorerefreshtokens" aria-hidden="true">#</a></h4><p>Get a new token pair via the provided refresh token. This invalidates the token pair that is used. To prevent refresh token stealing, it detects if the refresh token is already used, and if so does the following two things:</p><ul><li>Invalidates the session</li><li>Creates a <code>compas.sessionStore.potentialLeakedSession</code> job, with the digest of session duration and tokens used as the job &#39;data&#39;.</li></ul><p><strong>Example</strong>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sessionStoreRefreshTokens <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">accessTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 5 minutes</span>
  <span class="token literal-property property">refreshTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 24 hours</span>
  <span class="token literal-property property">signingKey</span><span class="token operator">:</span> <span class="token string">&quot;secure key loaded from secure place&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sessionStoreRefreshTokens</span><span class="token punctuation">(</span>
  <span class="token function">newEventFromEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
  sql<span class="token punctuation">,</span>
  settings<span class="token punctuation">,</span>
  ctx<span class="token punctuation">.</span>validatedBody<span class="token punctuation">.</span>refreshToken<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle error</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// return token pair to the caller</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Errors</strong>:</p><ul><li><code>validator.error</code> -&gt; thrown when <code>sessionSettings</code> has validator errors</li><li><code>error.server.internal</code> -&gt; if for some reason the JWT validating and signing library can&#39;t decode the refresh token, validate the provided refresh token or can&#39;t sign the new tokens.</li><li><code>sessionStore.verifyAndDecodeJWT.invalidToken</code> -&gt; when the token is not issued by this backend, or if it is edited by an unauthorized entity.</li><li><code>sessionStore.verifyAndDecodeJWT.expiredToken</code> -&gt; if the <code>exp</code> of the token before the current time.</li><li><code>sessionStore.refreshTokens.invalidRefreshToken</code> -&gt; when the decoded refresh token is not conforming the expected structure.</li><li><code>sessionStore.refreshTokens.invalidSession</code> -&gt; when no session can be found by the provided refresh token.</li><li><code>sessionStore.refreshTokens.revokedToken</code> -&gt; when the token is revoked, via for example <code>sessionStoreInvalidate</code> or when a new token pair is issued via <code>sessionStoreRefreshTokens</code>.</li></ul><h4 id="sessionstorecleanupexpiredsessions" tabindex="-1"><code>sessionStoreCleanupExpiredSessions</code> <a class="header-anchor" href="#sessionstorecleanupexpiredsessions" aria-hidden="true">#</a></h4><p>Cleanup tokens that are expired / revoked longer than &#39;maxRevokedAgeInDays&#39; days ago. Also removes the session if no tokens exist anymore. Note that when tokens are removed, Compas can&#39;t detect refresh token reuse, which hints on session stealing. A good default may be 45 days.</p><h3 id="session-transport" tabindex="-1">Session transport <a class="header-anchor" href="#session-transport" aria-hidden="true">#</a></h3><p>Compas also supports ways of transporting the JWT&#39;s. For now limited to reading from the HTTP Authorization header.</p><h4 id="sessiontransportsettings" tabindex="-1"><code>SessionTransportSettings</code> <a class="header-anchor" href="#sessiontransportsettings" aria-hidden="true">#</a></h4><p>An object that is expected by some session transport functions. Most of the properties have sensible defaults and are thus optional, but allow overriding.</p><ul><li><code>sessionStoreSettings</code> (<code>SessionStoreSettings</code>): Specify the session store settings, this is passed to <code>sessionStoreGet</code> and helps decoding and verifying tokens.</li></ul><p>The above properties are all required.</p><ul><li><code>enableHeaderTransport</code> (boolean): Enable or disable using the &#39;Authorization&#39; header for access token transport. Defaults to <code>true</code>.</li></ul><p>Transports are checked in the above order, and at least one transport needs to be enabled.</p><h4 id="sessiontransportloadfromcontext" tabindex="-1"><code>sessionTransportLoadFromContext</code> <a class="header-anchor" href="#sessiontransportloadfromcontext" aria-hidden="true">#</a></h4><p>Tries to load the session based on the provided context and options.</p><p>If <code>enableHeaderTransport</code> is set, the <code>Authorization</code> header is read first. The value is expected to be in the <code>Bearer $accessToken</code> format. When a token is found in the header, it is passed to <a href="#sessionstoreget"><code>sessionStoreGet</code></a> and the result is returned. If no access token is found, the following steps are taken.</p><p><strong>Example</strong>:</p><div class="language-js"><pre><code><span class="token keyword">import</span> <span class="token punctuation">{</span> sessionTransportLoadFromContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@compas/server&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sessionStoreSettings <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">accessTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 5 minutes</span>
  <span class="token literal-property property">refreshTokenMaxAgeInSeconds</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token comment">// 24 hours</span>
  <span class="token literal-property property">signingKey</span><span class="token operator">:</span> <span class="token string">&quot;secure key loaded from secure place&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sessionTransportSettings <span class="token operator">=</span> <span class="token punctuation">{</span>
  sessionStoreSettings<span class="token punctuation">,</span> <span class="token comment">// use defaults</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> error<span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">sessionTransportLoadFromContext</span><span class="token punctuation">(</span>
    <span class="token function">newEventFromEvent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
    sql<span class="token punctuation">,</span>
    ctx<span class="token punctuation">,</span>
    sessionTransportSettings<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// handle error</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// return token pair to the caller</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Errors</strong>:</p><ul><li>Infers all errors from <a href="#sessionstoreget"><code>sessionStoreGet</code></a></li><li><code>error.server.internal</code> -&gt; if the provided <code>SessionTransportSettings</code> are invalid.</li></ul></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><a class="link" href="https://github.com/compasjs/compas/edit/main/docs/features/session-handling.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>Edit this page on GitHub <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-07c132fc><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/features/background-jobs" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Background jobs</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/features/file-handling" data-v-38ede35f><span class="text" data-v-38ede35f>File handling</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"changelog.md\":\"a051c557\",\"contributing.md\":\"9bfce678\",\"examples.md\":\"20a7d50d\",\"features_background-jobs.md\":\"37d26688\",\"features_cli.md\":\"da0bbfcf\",\"features_code-gen-api-client.md\":\"4198e896\",\"features_code-gen-api.md\":\"5566d552\",\"features_code-gen-crud.md\":\"ef8194cf\",\"features_code-gen-sql.md\":\"c8c939a1\",\"features_code-gen-validators.md\":\"199472e2\",\"features_config-files.md\":\"0f11a587\",\"features_extending-the-cli.md\":\"6c205d8e\",\"features_file-handling.md\":\"8e8a72df\",\"features_http-server.md\":\"f0b10171\",\"features_lint-setup.md\":\"0e7b41d2\",\"features_logger-and-events.md\":\"9b76c254\",\"features_migrations.md\":\"233899ca\",\"features_postgres-and-minio.md\":\"507a97c4\",\"features_route-invalidations.md\":\"0e15fb4e\",\"features_session-handling.md\":\"098b3081\",\"features_test-and-bench-runner.md\":\"de3d5eee\",\"features_typescript-setup.md\":\"bae7af0c\",\"getting-started.md\":\"b88cae49\",\"index.md\":\"e7192c6b\",\"migrations_index.md\":\"83f1951e\",\"migrations_store.md\":\"6cddb0dd\",\"references_cli.md\":\"48cda47c\",\"references_compas-config.md\":\"fcd50741\",\"releases_0.0.103.md\":\"ffffe48f\",\"releases_0.0.115.md\":\"82be64cd\",\"releases_0.0.119.md\":\"857e335c\",\"releases_0.0.124.md\":\"64749ebb\",\"releases_0.0.138.md\":\"387d8339\",\"releases_0.0.158.md\":\"c5ef0701\",\"releases_0.0.171.md\":\"29980ce0\",\"releases_0.0.172.md\":\"f5893116\",\"releases_0.0.180.md\":\"4f4d6bea\",\"releases_0.0.79.md\":\"81bb756d\",\"releases_0.0.81.md\":\"f0c81d75\",\"releases_0.0.83.md\":\"9893b66f\",\"releases_0.0.84.md\":\"80f2a6ce\",\"releases_0.0.89.md\":\"389c7324\",\"releases_index.md\":\"d46c73ba\"}")</script>
    <script type="module" async src="/assets/app.cf930e1c.js"></script>
    
  </body>
</html>